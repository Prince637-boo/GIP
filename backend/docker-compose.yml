version: "3.8"
services:
  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      POSTGRES_DB: appdb
      POSTGRES_USER: app
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-change-me}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7
    restart: unless-stopped
    volumes: []

  minio:
    image: minio/minio:RELEASE.2025-01-01T00-00-00Z
    command: server /data
    environment:
      MINIO_ROOT_USER: ${S3_ACCESS_KEY:-minioadmin}
      MINIO_ROOT_PASSWORD: ${S3_SECRET_KEY:-minioadmin}
    ports:
      - "9000:9000"
    healthcheck:
      test: ["CMD", "stat", "/data"]
      interval: 10s
      retries: 3

  auth:
    build:
      context: .
      dockerfile: services/auth/Dockerfile
    env_file: .env
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "8001:8000"

  baggage:
    build:
      context: .
      dockerfile: services/baggage/Dockerfile
    env_file: .env
    depends_on:
      - postgres
    ports:
      - "8002:8000"

  weather:
    build:
      context: .
      dockerfile: services/weather/Dockerfile
    env_file: .env
    depends_on:
      - postgres
      - redis
    ports:
      - "8003:8000"
  
  # -------------------------------
  # RabbitMQ (Message broker)
  # -------------------------------
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin

  # -------------------------------
  # Redis (Cache + Pub/Sub)
  # -------------------------------
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"

  # -------------------------------
  # ElasticSearch
  # -------------------------------
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.13.0
    container_name: elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
    ports:
      - "9200:9200"

  # -------------------------------
  # Kibana
  # -------------------------------
  kibana:
    image: docker.elastic.co/kibana/kibana:8.13.0
    container_name: kibana
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200

  # -------------------------------
  # Logstash
  # -------------------------------
  logstash:
    image: docker.elastic.co/logstash/logstash:8.13.0
    container_name: logstash
    volumes:
      - ./logstash/pipeline:/usr/share/logstash/pipeline
    ports:
      - "5044:5044"
  
  traefik:
    image: traefik:v2.10
    command:
      - --api.insecure=true
      - --providers.docker=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --providers.file.filename=/etc/traefik/dynamic.yml
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro

  auth:
    image: auth:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=Host(`auth.localhost`) && PathPrefix(`/`)"
      - "traefik.http.routers.auth.entrypoints=web"
      - "traefik.http.services.auth.loadbalancer.server.port=8000"

  baggage:
    image: baggage:latest
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.baggage.rule=Host(`baggage.localhost`) && PathPrefix(`/`)"
      - "traefik.http.routers.baggage.entrypoints=web"
      - "traefik.http.services.baggage.loadbalancer.server.port=8000"



volumes:
  pgdata:
